<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hackathon Orchestrator Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; }
    .kpi-card { background-color: #1F2937; }
    .log-panel { background-color: #111827; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; }
    .status-sourced { background-color: #3B82F6; }
    .status-contacted { background-color: #F59E0B; }
    .status-accepted { background-color: #10B981; }
  </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">
  <div class="container mx-auto p-4 md:p-8">
    <!-- Header -->
    <header class="mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-white">Hackathon Orchestrator</h1>
      <p class="text-lg text-gray-400">AI-powered sourcing and scheduling for speakers & jurors.</p>
    </header>

    <!-- Main Content -->
    <main>
      <!-- Input & Launch Section -->
      <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
        <label for="sourcing-topic" class="block text-sm font-medium text-gray-300 mb-2">Sourcing Topic</label>
        <div class="flex flex-col sm:flex-row gap-4">
          <input type="text" id="sourcing-topic" class="flex-grow bg-gray-700 border border-gray-600 text-white rounded-md p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="e.g., 'AI in FinTech' or 'Decentralized Science'" />
          <input type="file" id="contacts-file" accept=".csv" class="hidden" />
          <button id="upload-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-md transition">Upload CSV</button>
          <button id="launch-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-md transition duration-300 shadow-md">ðŸš€ Launch Sourcing Agent</button>
        </div>
      </div>

      <!-- Dashboard & Logs Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Column: Dashboard -->
        <div class="lg:col-span-1 flex flex-col gap-8">
          <!-- KPI Cards -->
          <div>
            <h2 class="text-xl font-semibold text-white mb-4">Live Metrics</h2>
            <div class="grid grid-cols-3 gap-4">
              <div id="kpi-sourced" class="kpi-card p-4 rounded-lg text-center">
                <p class="text-3xl font-bold">0</p>
                <p class="text-sm text-gray-400">Sourced</p>
              </div>
              <div id="kpi-contacted" class="kpi-card p-4 rounded-lg text-center">
                <p class="text-3xl font-bold">0</p>
                <p class="text-sm text-gray-400">Contacted</p>
              </div>
              <div id="kpi-accepted" class="kpi-card p-4 rounded-lg text-center">
                <p class="text-3xl font-bold">0</p>
                <p class="text-sm text-gray-400">Accepted</p>
              </div>
            </div>
          </div>
          <!-- Candidate List -->
          <div>
            <h2 class="text-xl font-semibold text-white mb-4">Candidate Pipeline</h2>
            <div id="candidate-list" class="space-y-3">
              <!-- JS will populate this -->
              <p class="text-gray-500 text-center py-4">Launch an agent to see candidates here.</p>
            </div>
          </div>
        </div>

        <!-- Right Column: Live Log -->
        <div class="lg:col-span-2">
          <h2 class="text-xl font-semibold text-white mb-4">Live Execution Log</h2>
          <div id="log-panel" class="log-panel p-4 rounded-lg h-96 overflow-y-auto font-mono text-sm">
            <p class="text-gray-500">Awaiting agent launch...</p>
          </div>
        </div>
      </div>

      <!-- Business Plan & Goals -->
      <section class="mt-12 bg-gray-800 p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-semibold text-white mb-4">Business Plan & Goals</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <h3 class="text-lg font-semibold text-white">Problem</h3>
            <p class="text-gray-400 mt-2">Event teams spend weeks sourcing, emailing, and scheduling high-quality speakers and jurors. Manual workflows lead to low hit rates and missed deadlines.</p>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-white">Solution</h3>
            <p class="text-gray-400 mt-2">An AI-driven orchestrator that identifies experts, personalizes outreach, and books meetings automaticallyâ€”integrated with Gmail and Google Calendar.</p>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-white">Outcomes</h3>
            <ul class="text-gray-400 mt-2 list-disc list-inside space-y-1">
              <li>Reduce sourcing time by 80%+</li>
              <li>Increase response rates via personalized outreach</li>
              <li>Hands-free scheduling with conflict-aware calendars</li>
            </ul>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
          <div>
            <h3 class="text-lg font-semibold text-white">Target Users</h3>
            <ul class="text-gray-400 mt-2 list-disc list-inside space-y-1">
              <li>Hackathon organizers</li>
              <li>Conference teams</li>
              <li>University clubs</li>
            </ul>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-white">Pricing</h3>
            <p class="text-gray-400 mt-2">Tiered SaaS: Starter (per-event), Pro (monthly), Enterprise (SSO, audit logs, SLAs).</p>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-white">Roadmap</h3>
            <ul class="text-gray-400 mt-2 list-disc list-inside space-y-1">
              <li>CRM integrations (HubSpot, Salesforce)</li>
              <li>Multi-channel outreach (LinkedIn, email)</li>
              <li>Auto follow-ups and A/B testing</li>
            </ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // --- DOM Elements ---
    const launchBtn = document.getElementById('launch-btn');
    const uploadBtn = document.getElementById('upload-btn');
    const contactsInput = document.getElementById('contacts-file');
    const topicInput = document.getElementById('sourcing-topic');
    const logPanel = document.getElementById('log-panel');
    const candidateList = document.getElementById('candidate-list');
    const kpiSourced = document.getElementById('kpi-sourced').querySelector('p:first-child');
    const kpiContacted = document.getElementById('kpi-contacted').querySelector('p:first-child');
    const kpiAccepted = document.getElementById('kpi-accepted').querySelector('p:first-child');

    // --- Config ---
    const urlParams = new URLSearchParams(window.location.search);
    const apiPort = urlParams.get('api') || '8001';
    const apiBase = `http://127.0.0.1:${apiPort}`;

    // --- State & Mock Data ---
    let candidates = [];
    let uploadedCsvCandidates = [];
    let logEventSource = null;

    // --- Core Functions ---
    function addLog(message, type = 'info') {
      const colors = { info: 'text-gray-400', success: 'text-green-400', agent: 'text-blue-400' };
      const logEntry = document.createElement('p');
      logEntry.innerHTML = `<span class="mr-2">${new Date().toLocaleTimeString()}</span> <span class="${colors[type]}">${message}</span>`;
      logPanel.appendChild(logEntry);
      logPanel.scrollTop = logPanel.scrollHeight; // Auto-scroll
    }

    function updateDashboard() {
      kpiSourced.textContent = candidates.length;
      kpiContacted.textContent = candidates.filter(c => c.status === 'Contacted' || c.status === 'Accepted').length;
      kpiAccepted.textContent = candidates.filter(c => c.status === 'Accepted').length;

      candidateList.innerHTML = '';
      if (candidates.length === 0) {
        candidateList.innerHTML = '<p class="text-gray-500 text-center py-4">Launch an agent to see candidates here.</p>';
        return;
      }

      candidates.forEach(c => {
        const statusClasses = { Sourced: 'status-sourced', Contacted: 'status-contacted', Accepted: 'status-accepted' };
        const candidateEl = document.createElement('div');
        candidateEl.className = 'kpi-card p-3 rounded-md flex items-center justify-between';
        candidateEl.innerHTML = `
          <div>
            <p class="font-semibold text-white">${c.name}</p>
            <p class="text-xs text-gray-400">${c.expertise}</p>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs font-medium">${c.status}</span>
            <div class="status-dot ${statusClasses[c.status]}"></div>
          </div>
        `;
        candidateList.appendChild(candidateEl);
      });
    }

    function startBackendRun(topic) {
      if (logEventSource) {
        logEventSource.close();
        logEventSource = null;
      }

      // Start run
      // New demo-first flow: call demo/run-topic which reads contacts.csv and simulates outreach
      fetch(`${apiBase}/demo/run-topic?topic=${encodeURIComponent(topic)}`, { method: 'GET' })
        .then(r => r.json())
        .then(() => addLog('Run started...', 'info'))
        .catch(() => addLog('Failed to start run', 'info'));

      // Connect to logs SSE
      logEventSource = new EventSource(`${apiBase}/stream`);
      logEventSource.addEventListener('log', (ev) => {
        try {
          const data = JSON.parse(ev.data);
          addLog(data.message, 'agent');
        } catch (_) {}
      });
      logEventSource.addEventListener('candidates', (ev) => {
        try {
          candidates = JSON.parse(ev.data);
          updateDashboard();
        } catch (_) {}
      });
      logEventSource.addEventListener('candidate_status', (ev) => {
        try {
          const payload = JSON.parse(ev.data);
          const { index, status, email } = payload;
          if (typeof index === 'number' && candidates[index]) {
            candidates[index].status = status;
          } else if (email) {
            const c = candidates.find(c => c.email === email);
            if (c) c.status = status;
          }
          updateDashboard();
        } catch (_) {}
      });
      logEventSource.addEventListener('done', () => {
        addLog('Orchestration Complete.', 'success');
        launchBtn.disabled = false;
        launchBtn.textContent = 'ðŸš€ Launch Sourcing Agent';
        if (logEventSource) logEventSource.close();
      });
      logEventSource.onerror = () => {
        addLog('Stream disconnected.', 'info');
      };
    }

    // --- Event Listeners ---
    launchBtn.addEventListener('click', () => {
      const topic = topicInput.value.trim();
      if (!topic) {
        alert('Please enter a sourcing topic.');
        return;
      }

      // Reset UI
      launchBtn.disabled = true;
      launchBtn.textContent = 'Agents Running...';
      logPanel.innerHTML = '';
      candidates = [];
      updateDashboard();

      addLog(`Initializing agents for topic: "${topic}"`, 'info');
      startBackendRun(topic);
    });

    // CSV upload handlers
    uploadBtn.addEventListener('click', () => contactsInput.click());
    contactsInput.addEventListener('change', async () => {
      const file = contactsInput.files[0];
      if (!file) return;
      const text = await file.text();
      uploadedCsvCandidates = [];
      const lines = text.split(/\r?\n/).filter(Boolean);
      const [header, ...rows] = lines;
      const cols = header.split(',').map(s => s.trim().toLowerCase());
      const idxName = cols.indexOf('name');
      const idxEmail = cols.indexOf('email');
      const idxExpertise = cols.indexOf('expertise');
      rows.forEach(r => {
        const parts = r.split(',');
        const name = (parts[idxName] || '').trim();
        const email = (parts[idxEmail] || '').trim();
        const expertise = (parts[idxExpertise] || '').trim();
        if (email) uploadedCsvCandidates.push({ name, email, expertise, status: 'Sourced' });
      });
      addLog(`Loaded ${uploadedCsvCandidates.length} contacts from CSV.`, 'info');
      candidates = uploadedCsvCandidates.slice();
      updateDashboard();
    });

    // Initial state
    updateDashboard();
  </script>
</body>
</html>
