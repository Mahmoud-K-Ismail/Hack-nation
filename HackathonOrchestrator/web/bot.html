<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Discord Bot Configuration ‚Äî Hackathon Orchestrator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; }
  </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">
  <div class="container mx-auto p-4 md:p-8">
    <!-- Header / Nav -->
    <div class="flex items-center justify-between mb-6">
      <h1 class="text-2xl font-bold text-white">ü§ñ Discord Bot Configuration</h1>
      <div class="flex items-center gap-3">
        <a id="home-link" href="index.html" class="text-sm text-blue-400 hover:text-blue-300">‚Üê Back to Dashboard</a>
      </div>
    </div>

    <!-- Info -->
    <p class="text-gray-400 mb-6">Configure your hackathon Discord bot to handle FAQs, monitor chat, and escalate issues automatically.</p>

    <!-- Bot Config Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Basic Configuration -->
      <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
        <h3 class="text-lg font-semibold text-white mb-4">Basic Configuration</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Hackathon ID</label>
            <input type="text" id="discord-hackathon-id" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="hack-2025-nyuad" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Discord Server ID</label>
            <input type="text" id="discord-guild-id" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="123456789012345678" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Installation ID</label>
            <input type="text" id="discord-installation-id" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="install_abc123" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Escalation Channel ID</label>
            <input type="text" id="discord-escalation-channel" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="987654321012345678" />
          </div>
        </div>
      </div>

      <!-- Features Configuration -->
      <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
        <h3 class="text-lg font-semibold text-white mb-4">Bot Features</h3>
        <div class="space-y-3">
          <label class="flex items-center"><input type="checkbox" id="feature-faq-autoreply" class="h-5 w-5 text-blue-600" checked /><span class="ml-3 text-gray-300">FAQ Auto-replies</span></label>
          <label class="flex items-center"><input type="checkbox" id="feature-flood-detection" class="h-5 w-5 text-blue-600" checked /><span class="ml-3 text-gray-300">Flood Detection</span></label>
          <label class="flex items-center"><input type="checkbox" id="feature-escalation" class="h-5 w-5 text-blue-600" checked /><span class="ml-3 text-gray-300">Issue Escalation</span></label>
          <label class="flex items-center"><input type="checkbox" id="feature-scheduled-announcements" class="h-5 w-5 text-blue-600" checked /><span class="ml-3 text-gray-300">Scheduled Announcements</span></label>
          <label class="flex items-center"><input type="checkbox" id="feature-thread-autocreate" class="h-5 w-5 text-blue-600" checked /><span class="ml-3 text-gray-300">Auto-create Threads</span></label>
          <label class="flex items-center"><input type="checkbox" id="feature-sentiment-detection" class="h-5 w-5 text-blue-600" checked /><span class="ml-3 text-gray-300">Sentiment Detection</span></label>
          <label class="flex items-center"><input type="checkbox" id="feature-pin-auto-answers" class="h-5 w-5 text-blue-600" checked /><span class="ml-3 text-gray-300">Pin Auto-answers</span></label>
        </div>
      </div>

      <!-- Advanced Settings -->
      <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
        <h3 class="text-lg font-semibold text-white mb-4">Advanced Settings</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Bot Personality</label>
            <select id="discord-personality" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none">
              <option value="casual">Casual</option>
              <option value="formal">Formal</option>
              <option value="fun">Fun</option>
              <option value="custom">Custom</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Welcome Message</label>
            <textarea id="discord-welcome-message" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" rows="3" placeholder="Welcome to our hackathon! I'm here to help with questions and support."></textarea>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Escalation Threshold</label>
            <input type="range" id="discord-escalation-threshold" min="0" max="1" step="0.1" value="0.7" class="w-full" />
            <div class="flex justify-between text-xs text-gray-400">
              <span>Low (0.0)</span>
              <span id="threshold-value">0.7</span>
              <span>High (1.0)</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Webhook Configuration -->
      <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
        <h3 class="text-lg font-semibold text-white mb-4">Webhook Settings</h3>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-300 mb-2">Platform Webhook URL</label>
            <input type="url" id="discord-webhook-url" class="w-full bg-gray-700 border border-gray-600 text-white rounded-md p-2 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="https://platform.example/api/v1/bot/events" />
          </div>
          <label class="flex items-center">
            <input type="checkbox" id="feature-webhook-enabled" class="h-5 w-5 text-blue-600" checked />
            <span class="ml-3 text-gray-300">Send events to platform webhook</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="mt-6 flex flex-wrap gap-4">
      <button id="configure-discord-bot-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-md transition duration-300 shadow-md">‚öôÔ∏è Configure Bot</button>
      <button id="test-discord-config-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-md transition duration-300 shadow-md">üß™ Test Configuration</button>
      <button id="sync-discord-faqs-btn" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-md transition duration-300 shadow-md">üîÑ Sync FAQs</button>
      <button id="discord-health-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-md transition duration-300 shadow-md">‚ù§Ô∏è Check Bot Health</button>
    </div>

    <!-- Results Panel -->
    <div id="discord-results" class="mt-6 hidden">
      <div class="bg-gray-900 border border-gray-700 rounded-lg p-4">
        <h4 class="text-lg font-semibold text-white mb-2">Configuration Result</h4>
        <pre id="discord-results-content" class="text-green-400 bg-black p-3 rounded text-sm overflow-x-auto"></pre>
      </div>
    </div>

    <!-- Discord Events Stream -->
    <div id="discord-events-panel" class="mt-6">
      <h4 class="text-lg font-semibold text-white mb-4">Discord Bot Events</h4>
      <div id="discord-events-log" class="bg-gray-900 p-4 rounded-lg h-48 overflow-y-auto font-mono text-sm">
        <p class="text-gray-500">No Discord events yet...</p>
      </div>
    </div>

    <!-- Local log panel -->
    <div class="mt-6">
      <h4 class="text-lg font-semibold text-white mb-4">Action Log</h4>
      <div id="local-log" class="bg-gray-900 p-4 rounded-lg h-40 overflow-y-auto font-mono text-sm">
        <p class="text-gray-500">Waiting for actions...</p>
      </div>
    </div>
  </div>

  <script>
    // Config
    const urlParams = new URLSearchParams(window.location.search);
    const apiPort = urlParams.get('api') || '8001';
    const apiBase = `http://127.0.0.1:${apiPort}`;

    // Update home link to preserve api param
    const homeLink = document.getElementById('home-link');
    homeLink.href = `index.html?api=${apiPort}`;

    // Local log helper
    const localLog = document.getElementById('local-log');
    function addLog(message, type = 'info') {
      const colors = { info: 'text-gray-400', success: 'text-green-400' };
      const p = document.createElement('p');
      p.className = colors[type] || colors.info;
      p.innerHTML = `<span class="mr-2">${new Date().toLocaleTimeString()}</span> ${message}`;
      // Remove placeholder
      const ph = localLog.querySelector('p');
      if (ph && ph.textContent.includes('Waiting for actions')) ph.remove();
      localLog.appendChild(p);
      localLog.scrollTop = localLog.scrollHeight;
    }

    // Discord UI elements
    const discordResults = document.getElementById('discord-results');
    const discordResultsContent = document.getElementById('discord-results-content');
    const discordEventsLog = document.getElementById('discord-events-log');
    const thresholdSlider = document.getElementById('discord-escalation-threshold');
    const thresholdValue = document.getElementById('threshold-value');

    thresholdSlider.addEventListener('input', (e) => {
      thresholdValue.textContent = e.target.value;
    });

    function showDiscordResult(result, isError = false) {
      discordResults.classList.remove('hidden');
      discordResultsContent.textContent = JSON.stringify(result, null, 2);
      discordResultsContent.className = isError
        ? 'text-red-400 bg-black p-3 rounded text-sm overflow-x-auto'
        : 'text-green-400 bg-black p-3 rounded text-sm overflow-x-auto';
    }

    function addDiscordEvent(eventData) {
      const timestamp = new Date().toLocaleTimeString();
      const eventDiv = document.createElement('div');
      eventDiv.className = 'mb-2 p-2 border-l-2 border-blue-500 bg-gray-800';
      eventDiv.innerHTML = `
        <div class="text-xs text-gray-400">${timestamp}</div>
        <div class="text-sm text-blue-300">${eventData.type || 'unknown'}</div>
        <div class="text-xs text-gray-300">${JSON.stringify(eventData, null, 2)}</div>
      `;
      const placeholder = discordEventsLog.querySelector('p');
      if (placeholder && placeholder.textContent.includes('No Discord events yet')) {
        placeholder.remove();
      }
      discordEventsLog.appendChild(eventDiv);
      discordEventsLog.scrollTop = discordEventsLog.scrollHeight;
    }

    function getDiscordConfiguration() {
      return {
        hackathon_id: document.getElementById('discord-hackathon-id').value,
        discord: {
          guild_id: document.getElementById('discord-guild-id').value,
          installation_id: document.getElementById('discord-installation-id').value
        },
        features: {
          faq_autoreply: document.getElementById('feature-faq-autoreply').checked,
          flood_detection: document.getElementById('feature-flood-detection').checked,
          escalation: document.getElementById('feature-escalation').checked,
          scheduled_announcements: document.getElementById('feature-scheduled-announcements').checked,
          thread_autocreate: document.getElementById('feature-thread-autocreate').checked,
          sentiment_detection: document.getElementById('feature-sentiment-detection').checked,
          pin_auto_answers: document.getElementById('feature-pin-auto-answers').checked
        },
        escalation: {
          enabled: document.getElementById('feature-escalation').checked,
          channel_id: document.getElementById('discord-escalation-channel').value,
          escalation_threshold: parseFloat(document.getElementById('discord-escalation-threshold').value),
          notify_roles: []
        },
        faq: { source: 'platform', auto_sync: true, sync_interval_minutes: 15 },
        schedule: { source: 'platform', timezone: 'UTC', reminder_lead_minutes: [10, 60, 1440] },
        embeddings: { vector_store: 'pgvector', similarity_threshold: 0.78 },
        personality: {
          tone: document.getElementById('discord-personality').value,
          welcome_message: document.getElementById('discord-welcome-message').value || undefined
        },
        logging: {
          send_to_platform_webhook: document.getElementById('feature-webhook-enabled').checked,
          platform_webhook_url: document.getElementById('discord-webhook-url').value
        }
      };
    }

    async function configureDiscordBot() {
      const config = getDiscordConfiguration();
      if (!config.hackathon_id || !config.discord.guild_id || !config.discord.installation_id) {
        alert('Please fill in all required fields (Hackathon ID, Discord Server ID, Installation ID)');
        return;
      }
      if (config.features.escalation && !config.escalation.channel_id) {
        alert('Please provide an escalation channel ID when escalation is enabled');
        return;
      }
      if (config.logging.send_to_platform_webhook && !config.logging.platform_webhook_url) {
        alert('Please provide a webhook URL when webhook events are enabled');
        return;
      }

      const btn = document.getElementById('configure-discord-bot-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = '‚öôÔ∏è Configuring...';

      try {
        const response = await fetch(`${apiBase}/api/v1/bot/configure`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer demo-token' },
          body: JSON.stringify(config)
        });
        const result = await response.json();
        if (response.ok) {
          showDiscordResult(result);
          addLog('‚úÖ Discord bot configured successfully', 'success');
          addDiscordEvent({ type: 'bot_configured', config_id: result.config_id });
        } else {
          throw new Error(result.detail || 'Configuration failed');
        }
      } catch (error) {
        showDiscordResult({ error: error.message }, true);
        addLog(`‚ùå Discord bot configuration failed: ${error.message}`);
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function testDiscordConfig() {
      const config = getDiscordConfiguration();
      const btn = document.getElementById('test-discord-config-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'üß™ Testing...';
      try {
        const response = await fetch(`${apiBase}/api/v1/bot/configure?hackathon_id=${config.hackathon_id}`, {
          method: 'GET', headers: { 'Authorization': 'Bearer demo-token' }
        });
        if (response.ok) {
          const result = await response.json();
          showDiscordResult({ status: 'Configuration test passed', config: result });
          addLog('‚úÖ Discord bot configuration test passed', 'success');
        } else if (response.status === 404) {
          showDiscordResult({ status: 'No configuration found', message: 'Please configure the bot first' });
          addLog('‚ÑπÔ∏è No Discord bot configuration found for this hackathon');
        } else {
          throw new Error('Configuration test failed');
        }
      } catch (error) {
        showDiscordResult({ error: error.message }, true);
        addLog(`‚ùå Discord bot test failed: ${error.message}`);
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function syncDiscordFAQs() {
      const hackathonId = document.getElementById('discord-hackathon-id').value;
      if (!hackathonId) { alert('Please provide a Hackathon ID'); return; }

      const btn = document.getElementById('sync-discord-faqs-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'üîÑ Syncing...';
      try {
        const faqResponse = await fetch(`${apiBase}/hackathon/${hackathonId}/faq`, { method: 'POST' });
        if (!faqResponse.ok) throw new Error('Failed to fetch FAQs from platform');
        const faqData = await faqResponse.json();

        const syncResponse = await fetch(`${apiBase}/discord/faq/sync`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ hackathon_id: hackathonId, faqs: faqData.faqs })
        });
        const result = await syncResponse.json();
        if (syncResponse.ok) {
          showDiscordResult(result);
          addLog(`‚úÖ Synced ${result.synced_count} FAQs with Discord bot`, 'success');
          addDiscordEvent({ type: 'faq_sync', synced_count: result.synced_count });
        } else {
          throw new Error(result.detail || 'FAQ sync failed');
        }
      } catch (error) {
        showDiscordResult({ error: error.message }, true);
        addLog(`‚ùå FAQ sync failed: ${error.message}`);
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    async function checkDiscordHealth() {
      const btn = document.getElementById('discord-health-btn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = '‚ù§Ô∏è Checking...';
      try {
        const response = await fetch(`${apiBase}/discord/health`);
        const result = await response.json();
        showDiscordResult(result);
        addLog(result.ok ? '‚úÖ Discord bot service is healthy' : `‚ö†Ô∏è Discord bot service status: ${result.status}`, result.ok ? 'success' : 'info');
      } catch (error) {
        showDiscordResult({ error: error.message }, true);
        addLog(`‚ùå Discord health check failed: ${error.message}`);
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    // Event listeners
    document.getElementById('configure-discord-bot-btn').addEventListener('click', configureDiscordBot);
    document.getElementById('test-discord-config-btn').addEventListener('click', testDiscordConfig);
    document.getElementById('sync-discord-faqs-btn').addEventListener('click', syncDiscordFAQs);
    document.getElementById('discord-health-btn').addEventListener('click', checkDiscordHealth);
  </script>
</body>
</html>


