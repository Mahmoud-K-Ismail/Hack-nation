<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Hackathon Orchestrator Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; }
    .kpi-card { background-color: #1F2937; }
    .log-panel { background-color: #111827; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; }
    .status-sourced { background-color: #3B82F6; }
    .status-contacted { background-color: #F59E0B; }
    .status-accepted { background-color: #10B981; }
  </style>
</head>
<body class="bg-gray-900 text-gray-200 antialiased">
  <div class="container mx-auto p-4 md:p-8">
    <!-- Header -->
    <header class="mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-white">Hackathon Orchestrator</h1>
      <p class="text-lg text-gray-400">AI-powered sourcing and scheduling for speakers & jurors.</p>
      <div class="mt-2 text-sm text-gray-500">
        <span>Frontend: <span id="frontend-url" class="text-blue-400"></span></span>
        <span class="mx-2">|</span>
        <span>Backend: <span id="backend-url" class="text-green-400"></span></span>
        <span class="mx-2">|</span>
        <span>API Port: <input type="number" id="api-port-input" value="8001" min="1000" max="9999" class="w-16 bg-gray-700 border border-gray-600 text-white rounded px-2 py-1 text-xs" /></span>
        <button id="update-api-btn" class="ml-2 bg-gray-600 hover:bg-gray-500 text-white text-xs px-2 py-1 rounded">Update</button>
      </div>
    </header>

    <!-- Main Content -->
    <main>
      <!-- Input & Launch Section -->
      <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
        <label for="sourcing-topic" class="block text-sm font-medium text-gray-300 mb-2">Sourcing Topic</label>
        <div class="flex flex-col sm:flex-row gap-4">
          <input type="text" id="sourcing-topic" class="flex-grow bg-gray-700 border border-gray-600 text-white rounded-md p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="e.g., 'AI in FinTech' or 'Decentralized Science'" />
          <input type="file" id="contacts-file" accept=".csv" class="hidden" />
          <button id="upload-btn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-md transition">Upload CSV</button>
          <button id="launch-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-md transition duration-300 shadow-md">üöÄ Launch Sourcing Agent</button>
        </div>
      </div>

      <!-- Speaker Finder Section -->
      <div class="bg-gray-800 p-6 rounded-lg shadow-lg mb-8">
        <h2 class="text-xl font-semibold text-white mb-4">üé§ Speaker & Jury Finder</h2>
        <p class="text-gray-400 mb-4">Find speakers and jury members for your hackathon topic and get a Google Sheets link instantly.</p>
        <div class="flex flex-col sm:flex-row gap-4">
          <input type="text" id="speaker-topic" class="flex-grow bg-gray-700 border border-gray-600 text-white rounded-md p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="e.g., 'AI in FinTech', 'Cybersecurity', 'Blockchain'" />
          <input type="number" id="speaker-count" class="w-24 bg-gray-700 border border-gray-600 text-white rounded-md p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="20" min="1" max="50" value="20" />
          <button id="find-speakers-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-md transition duration-300 shadow-md">üîç Find Speakers</button>
          <button id="test-backend-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 shadow-md">üß™ Test Backend</button>
          <button id="test-speakers-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-md transition duration-300 shadow-md">üé§ Test Speakers</button>
        </div>
        <div id="speaker-result" class="mt-4 hidden">
          <div class="bg-green-900 border border-green-700 rounded-lg p-4">
            <h3 class="text-lg font-semibold text-green-200 mb-2">‚úÖ Speakers Found!</h3>
            <p id="speaker-message" class="text-green-300 mb-3"></p>
            <a id="spreadsheet-link" href="#" target="_blank" class="inline-block bg-green-700 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-300">üìä Open Google Sheets</a>
          </div>
        </div>
        <div id="speaker-error" class="mt-4 hidden">
          <div class="bg-red-900 border border-red-700 rounded-lg p-4">
            <h3 class="text-lg font-semibold text-red-200 mb-2">‚ùå Error</h3>
            <p id="speaker-error-message" class="text-red-300"></p>
          </div>
        </div>
      </div>

      <!-- Dashboard & Logs Grid -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Left Column: Dashboard -->
        <div class="lg:col-span-1 flex flex-col gap-8">
          <!-- KPI Cards -->
          <div>
            <h2 class="text-xl font-semibold text-white mb-4">Live Metrics</h2>
            <div class="grid grid-cols-3 gap-4">
              <div id="kpi-sourced" class="kpi-card p-4 rounded-lg text-center">
                <p class="text-3xl font-bold">0</p>
                <p class="text-sm text-gray-400">Sourced</p>
              </div>
              <div id="kpi-contacted" class="kpi-card p-4 rounded-lg text-center">
                <p class="text-3xl font-bold">0</p>
                <p class="text-sm text-gray-400">Contacted</p>
              </div>
              <div id="kpi-accepted" class="kpi-card p-4 rounded-lg text-center">
                <p class="text-3xl font-bold">0</p>
                <p class="text-sm text-gray-400">Accepted</p>
              </div>
            </div>
          </div>
          <!-- Candidate List -->
          <div>
            <h2 class="text-xl font-semibold text-white mb-4">Candidate Pipeline</h2>
            <div id="candidate-list" class="space-y-3">
              <!-- JS will populate this -->
              <p class="text-gray-500 text-center py-4">Launch an agent to see candidates here.</p>
            </div>
          </div>
        </div>

        <!-- Right Column: Live Log -->
        <div class="lg:col-span-2">
          <h2 class="text-xl font-semibold text-white mb-4">Live Execution Log</h2>
          <div id="log-panel" class="log-panel p-4 rounded-lg h-96 overflow-y-auto font-mono text-sm">
            <p class="text-gray-500">Awaiting agent launch...</p>
          </div>
        </div>
      </div>

      <!-- Business Plan & Goals -->
      <section class="mt-12 bg-gray-800 p-6 rounded-lg shadow-lg">
        <h2 class="text-2xl font-semibold text-white mb-4">Business Plan & Goals</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <h3 class="text-lg font-semibold text-white">Problem</h3>
            <p class="text-gray-400 mt-2">Event teams spend weeks sourcing, emailing, and scheduling high-quality speakers and jurors. Manual workflows lead to low hit rates and missed deadlines.</p>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-white">Solution</h3>
            <p class="text-gray-400 mt-2">An AI-driven orchestrator that identifies experts, personalizes outreach, and books meetings automatically‚Äîintegrated with Gmail and Google Calendar.</p>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-white">Outcomes</h3>
            <ul class="text-gray-400 mt-2 list-disc list-inside space-y-1">
              <li>Reduce sourcing time by 80%+</li>
              <li>Increase response rates via personalized outreach</li>
              <li>Hands-free scheduling with conflict-aware calendars</li>
            </ul>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
          <div>
            <h3 class="text-lg font-semibold text-white">Target Users</h3>
            <ul class="text-gray-400 mt-2 list-disc list-inside space-y-1">
              <li>Hackathon organizers</li>
              <li>Conference teams</li>
              <li>University clubs</li>
            </ul>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-white">Pricing</h3>
            <p class="text-gray-400 mt-2">Tiered SaaS: Starter (per-event), Pro (monthly), Enterprise (SSO, audit logs, SLAs).</p>
          </div>
          <div>
            <h3 class="text-lg font-semibold text-white">Roadmap</h3>
            <ul class="text-gray-400 mt-2 list-disc list-inside space-y-1">
              <li>CRM integrations (HubSpot, Salesforce)</li>
              <li>Multi-channel outreach (LinkedIn, email)</li>
              <li>Auto follow-ups and A/B testing</li>
            </ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // --- DOM Elements ---
    const launchBtn = document.getElementById('launch-btn');
    const uploadBtn = document.getElementById('upload-btn');
    const contactsInput = document.getElementById('contacts-file');
    const topicInput = document.getElementById('sourcing-topic');
    const logPanel = document.getElementById('log-panel');
    const candidateList = document.getElementById('candidate-list');
    const kpiSourced = document.getElementById('kpi-sourced').querySelector('p:first-child');
    const kpiContacted = document.getElementById('kpi-contacted').querySelector('p:first-child');
    const kpiAccepted = document.getElementById('kpi-accepted').querySelector('p:first-child');

    // Speaker Finder Elements
    const speakerTopicInput = document.getElementById('speaker-topic');
    const speakerCountInput = document.getElementById('speaker-count');
    const findSpeakersBtn = document.getElementById('find-speakers-btn');
    const testBackendBtn = document.getElementById('test-backend-btn');
    const testSpeakersBtn = document.getElementById('test-speakers-btn');
    const apiPortInput = document.getElementById('api-port-input');
    const updateApiBtn = document.getElementById('update-api-btn');
    const speakerResult = document.getElementById('speaker-result');
    const speakerError = document.getElementById('speaker-error');
    const speakerMessage = document.getElementById('speaker-message');
    const spreadsheetLink = document.getElementById('spreadsheet-link');
    const speakerErrorMessage = document.getElementById('speaker-error-message');

    // --- Config ---
    const urlParams = new URLSearchParams(window.location.search);
    const apiPort = urlParams.get('api') || '8001';
    const apiBase = `http://127.0.0.1:${apiPort}`;
    
    // Debug: Log the API base URL
    console.log('API Base URL:', apiBase);
    console.log('Frontend URL:', window.location.href);
    
    // Update URL indicators
    document.getElementById('frontend-url').textContent = window.location.href;
    document.getElementById('backend-url').textContent = apiBase;

    // --- State & Mock Data ---
    let candidates = [];
    let uploadedCsvCandidates = [];
    let logEventSource = null;

    // --- Core Functions ---
    function addLog(message, type = 'info') {
      const colors = { info: 'text-gray-400', success: 'text-green-400', agent: 'text-blue-400' };
      const logEntry = document.createElement('p');
      logEntry.innerHTML = `<span class="mr-2">${new Date().toLocaleTimeString()}</span> <span class="${colors[type]}">${message}</span>`;
      logPanel.appendChild(logEntry);
      logPanel.scrollTop = logPanel.scrollHeight; // Auto-scroll
    }

    function updateDashboard() {
      kpiSourced.textContent = candidates.length;
      kpiContacted.textContent = candidates.filter(c => c.status === 'Contacted' || c.status === 'Accepted').length;
      kpiAccepted.textContent = candidates.filter(c => c.status === 'Accepted').length;

      candidateList.innerHTML = '';
      if (candidates.length === 0) {
        candidateList.innerHTML = '<p class="text-gray-500 text-center py-4">Launch an agent to see candidates here.</p>';
        return;
      }

      candidates.forEach(c => {
        const statusClasses = { Sourced: 'status-sourced', Contacted: 'status-contacted', Accepted: 'status-accepted' };
        const candidateEl = document.createElement('div');
        candidateEl.className = 'kpi-card p-3 rounded-md flex items-center justify-between';
        candidateEl.innerHTML = `
          <div>
            <p class="font-semibold text-white">${c.name}</p>
            <p class="text-xs text-gray-400">${c.expertise}</p>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-xs font-medium">${c.status}</span>
            <div class="status-dot ${statusClasses[c.status]}"></div>
          </div>
        `;
        candidateList.appendChild(candidateEl);
      });
    }

    function startBackendRun(topic) {
      if (logEventSource) {
        logEventSource.close();
        logEventSource = null;
      }

      // Start run
      // New demo-first flow: call demo/run-topic which reads contacts.csv and simulates outreach
      fetch(`${apiBase}/demo/run-topic?topic=${encodeURIComponent(topic)}`, { method: 'GET' })
        .then(r => r.json())
        .then(() => addLog('Run started...', 'info'))
        .catch(() => addLog('Failed to start run', 'info'));

      // Connect to logs SSE
      logEventSource = new EventSource(`${apiBase}/stream`);
      logEventSource.addEventListener('log', (ev) => {
        try {
          const data = JSON.parse(ev.data);
          addLog(data.message, 'agent');
        } catch (_) {}
      });
      logEventSource.addEventListener('candidates', (ev) => {
        try {
          candidates = JSON.parse(ev.data);
          updateDashboard();
        } catch (_) {}
      });
      logEventSource.addEventListener('candidate_status', (ev) => {
        try {
          const payload = JSON.parse(ev.data);
          const { index, status, email } = payload;
          if (typeof index === 'number' && candidates[index]) {
            candidates[index].status = status;
          } else if (email) {
            const c = candidates.find(c => c.email === email);
            if (c) c.status = status;
          }
          updateDashboard();
        } catch (_) {}
      });
      logEventSource.addEventListener('done', () => {
        addLog('Orchestration Complete.', 'success');
        launchBtn.disabled = false;
        launchBtn.textContent = 'üöÄ Launch Sourcing Agent';
        if (logEventSource) logEventSource.close();
      });
      logEventSource.onerror = () => {
        addLog('Stream disconnected.', 'info');
      };
    }

    // --- Speaker Finder Functions ---
    async function findSpeakers() {
      const topic = speakerTopicInput.value.trim();
      const maxResults = parseInt(speakerCountInput.value) || 20;
      
      if (!topic) {
        alert('Please enter a topic to search for speakers.');
        return;
      }
      
      // Reset UI
      speakerResult.classList.add('hidden');
      speakerError.classList.add('hidden');
      findSpeakersBtn.disabled = true;
      findSpeakersBtn.textContent = 'üîç Searching...';
      
      console.log('Calling API:', `${apiBase}/speakers/find`);
      console.log('Request payload:', { topic, max_results: maxResults });
      
      try {
        const response = await fetch(`${apiBase}/speakers/find`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            topic: topic,
            max_results: maxResults
          })
        });
        
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.ok) {
          speakerMessage.textContent = data.message;
          spreadsheetLink.href = data.spreadsheet_url;
          speakerResult.classList.remove('hidden');
          addLog(`Found ${maxResults} speakers for "${topic}" and created Google Sheets`, 'success');
        } else {
          throw new Error(data.detail || 'Failed to find speakers');
        }
      } catch (error) {
        console.error('Error in findSpeakers:', error);
        speakerErrorMessage.textContent = error.message;
        speakerError.classList.remove('hidden');
        addLog(`Error finding speakers: ${error.message}`, 'info');
      } finally {
        findSpeakersBtn.disabled = false;
        findSpeakersBtn.textContent = 'üîç Find Speakers';
      }
    }
    
    // --- Test Backend Function ---
    async function testBackend() {
      testBackendBtn.disabled = true;
      testBackendBtn.textContent = 'üß™ Testing...';
      
      try {
        console.log('Testing backend connection to:', `${apiBase}/health`);
        const response = await fetch(`${apiBase}/health`);
        console.log('Health check response:', response.status, response.statusText);
        
        if (response.ok) {
          const data = await response.json();
          console.log('Health check data:', data);
          addLog('‚úÖ Backend is connected and healthy!', 'success');
          alert('‚úÖ Backend is connected and healthy!');
        } else {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
      } catch (error) {
        console.error('Backend test failed:', error);
        addLog(`‚ùå Backend test failed: ${error.message}`, 'info');
        alert(`‚ùå Backend test failed: ${error.message}`);
      } finally {
        testBackendBtn.disabled = false;
        testBackendBtn.textContent = 'üß™ Test Backend';
      }
    }
    
    // --- Update API Port Function ---
    function updateApiPort() {
      const newPort = apiPortInput.value;
      if (newPort && newPort !== apiPort) {
        apiPort = newPort;
        apiBase = `http://127.0.0.1:${apiPort}`;
        document.getElementById('backend-url').textContent = apiBase;
        console.log('API port updated to:', apiPort);
        console.log('New API base:', apiBase);
        addLog(`API port updated to ${apiPort}`, 'info');
      }
    }
    
    // --- Test Speakers Endpoint Function ---
    async function testSpeakersEndpoint() {
      testSpeakersBtn.disabled = true;
      testSpeakersBtn.textContent = 'üé§ Testing...';
      
      try {
        console.log('Testing speakers endpoint:', `${apiBase}/speakers/health`);
        const response = await fetch(`${apiBase}/speakers/health`);
        console.log('Speakers health check response:', response.status, response.statusText);
        
        if (response.ok) {
          const data = await response.json();
          console.log('Speakers health check data:', data);
          addLog('‚úÖ Speakers endpoint is healthy!', 'success');
          alert('‚úÖ Speakers endpoint is healthy!');
        } else {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
      } catch (error) {
        console.error('Speakers endpoint test failed:', error);
        addLog(`‚ùå Speakers endpoint test failed: ${error.message}`, 'info');
        alert(`‚ùå Speakers endpoint test failed: ${error.message}`);
      } finally {
        testSpeakersBtn.disabled = false;
        testSpeakersBtn.textContent = 'üé§ Test Speakers';
      }
    }

    // --- Event Listeners ---
    launchBtn.addEventListener('click', () => {
      const topic = topicInput.value.trim();
      if (!topic) {
        alert('Please enter a sourcing topic.');
        return;
      }

      // Reset UI
      launchBtn.disabled = true;
      launchBtn.textContent = 'Agents Running...';
      logPanel.innerHTML = '';
      candidates = [];
      updateDashboard();

      addLog(`Initializing agents for topic: "${topic}"`, 'info');
      startBackendRun(topic);
    });

    // CSV upload handlers
    uploadBtn.addEventListener('click', () => contactsInput.click());
    
    // Speaker finder handler
    findSpeakersBtn.addEventListener('click', findSpeakers);
    
    // Test backend handler
    testBackendBtn.addEventListener('click', testBackend);
    
    // Update API port handler
    updateApiBtn.addEventListener('click', updateApiPort);
    
    // Test speakers endpoint handler
    testSpeakersBtn.addEventListener('click', testSpeakersEndpoint);
    
    contactsInput.addEventListener('change', async () => {
      const file = contactsInput.files[0];
      if (!file) return;
      const text = await file.text();
      uploadedCsvCandidates = [];
      const lines = text.split(/\r?\n/).filter(Boolean);
      const [header, ...rows] = lines;
      const cols = header.split(',').map(s => s.trim().toLowerCase());
      const idxName = cols.indexOf('name');
      const idxEmail = cols.indexOf('email');
      const idxExpertise = cols.indexOf('expertise');
      rows.forEach(r => {
        const parts = r.split(',');
        const name = (parts[idxName] || '').trim();
        const email = (parts[idxEmail] || '').trim();
        const expertise = (parts[idxExpertise] || '').trim();
        if (email) uploadedCsvCandidates.push({ name, email, expertise, status: 'Sourced' });
      });
      addLog(`Loaded ${uploadedCsvCandidates.length} contacts from CSV.`, 'info');
      candidates = uploadedCsvCandidates.slice();
      updateDashboard();
    });

    // Initial state
    updateDashboard();
  </script>
</body>
</html>
